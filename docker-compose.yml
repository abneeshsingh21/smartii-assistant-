version: '3.8'

services:
  smartii-backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/smartii
      - REDIS_URL=redis://redis:6379
      - MONGO_URL=mongodb://mongo:27017/smartii
      - CHROMA_URL=http://chroma:8000
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
    depends_on:
      - db
      - redis
      - mongo
      - chroma
      - mosquitto
    volumes:
      - ./backend:/app
    networks:
      - smartii-network

  smartii-frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - smartii-backend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - smartii-network

  db:
    image: postgres:15
    environment:
      POSTGRES_DB: smartii
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - smartii-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - smartii-network

  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - smartii-network

  chroma:
    image: chromadb/chroma:latest
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/data
    ports:
      - "8001:8000"
    volumes:
      - chroma_data:/chroma/data
    networks:
      - smartii-network

  mosquitto:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - smartii-network

  node-realtime:
    build: ./node-realtime
    environment:
      - REDIS_URL=redis://redis:6379
      - EVENTS_CHANNEL=smartii.events
    ports:
      - "8080:8080"
    depends_on:
      - redis
    networks:
      - smartii-network

  go-worker:
    build: ./go-worker
    environment:
      - REDIS_URL=redis://redis:6379
      - JOBS_KEY=smartii.jobs
      - JOB_STATUS_PREFIX=smartii.job.
    depends_on:
      - redis
    networks:
      - smartii-network

volumes:
  postgres_data:
  redis_data:
  mongo_data:
  chroma_data:
  mosquitto_data:
  mosquitto_log:

networks:
  smartii-network:
    driver: bridge
